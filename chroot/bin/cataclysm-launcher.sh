#! /bin/bash
#############################################################################
#
# WARNING!  AUTO-GENERATED FILE, DO NOT EDIT.
#
# This file (dwarf-fortress-launcher.sh) is automatically generated from /home/crawl-dev/crawl-dev/dgamelaunch-config/chroot/bin/dwarf-fortress-launcher.sh.
#
# Do NOT edit this file; edit /home/crawl-dev/crawl-dev/dgamelaunch-config/chroot/bin/dwarf-fortress-launcher.sh instead, and
# use `dgl publish` to publish your changes.
#
#############################################################################
#

user=$1
major_version=$2
cattype=$3

#don't use / for end of path so find/replace works correctly

catdir="/catdir/${major_version}/cat_linux"
userdir="/catdir/${major_version}/cat_$user"
catlauncher="/bin/cat-launch.sh"
cathacklauncher="/bin/cathack-launch.sh"
dwizzell="/bin/cwizzell.pl.sh"
MAXGAMES=6
inprogressdir="/dgldir/inprogress/cataclysm"

#check to see if dir exist

if [ ! -d "$userdir" ]; then

  echo "MAKING NEW USER DIRECTORY!"
  mkdir "$userdir"

  echo "SETTING UP USER DIRECTORY! THIS MAY TAKE SEVERAL MOMENTS!"
  cd "$userdir"
  (cd "$catdir"; find -type d ! -name .) |xargs mkdir -p

  cd "$userdir"
  for file in `find $catdir -type f`
  do
      catdir_path=$(dirname $file)
      user_path="${catdir_path/$catdir/$userdir}"
      cd "$user_path"
      ln  $catdir_path/$(basename $file)
  done

  chmod -R 755 "$user_path"


  #then delete saved games
#  rm -r "$userdir/data/save"
#  mkdir "$userdir/data/save"

  #then add default worlds
#  cp -R $catdir/data/save $userdir/data

  #delete the gamelog.txt then touch the new one
#  rm -r "$userdir/gamelog.txt"
#  touch "$userdir/gamelog.txt"

  #do a regular copy of the data/init/init.txt file
#  rm "$userdir/data/init/*"
  

   
fi

launchscript=$userdir/cat-launch.sh
cp "$catlauncher" "$launchscript"

#use sed to replace XXXXXX with $user in cwizzell.pl and save it there.
sed "s/|cat_XXXXXX/|cat_${user}/g" $cwizzell |\
sed "s/cat_XXXXXX/${major_version}\/cat_${user}/g"> "$userdir/cwizzell.pl"



#check to see if we have enough open slots
num_current_games=`ls -1 ${inprogressdir} |wc -l`

if [ "${num_current_games}" -gt "${MAXGAMES}" ]; then
   exec /bin/too-many-cat-games.sh
else
   #now run the game
   cd "$userdir"
   echo "Running $launchscript"
   exec "$launchscript"
   #exec strace -v -s 4096 -ff -o /tmp/traces/trace.$$. $userdir/cat 
fi


